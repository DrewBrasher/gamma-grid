/*! gamma-grid - v0.2.1 - 2016-12-12
* Copyright (c) 2016 ; Licensed  */
!function(a){a.fn.gammaGrid=function(b,c){function d(a){var b="";for(var c in a)c&&(b+=encodeURIComponent(c)+"="+encodeURIComponent(a[c])+"&");return b.lastIndexOf("&")==b.length-1&&(b=b.substring(0,b.length-1)),b}function e(a){0===a.indexOf("?")&&(a=a.substring(1));for(var b={},c=a.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return b}Object.keys||(Object.keys=function(a){var b,c=[];for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&c.push(b);return c});var f=this,g={};a("body");f.addClass("gammaGrid");var h=b.baseUrl.indexOf("?")>-1?b.baseUrl.substring(0,b.baseUrl.indexOf("?")):b.baseUrl,i=b.pager||function(a,c,e,f){f.skip=c;var g=e>c?"<a href='?"+d(f)+"'>Next&rarr;</a>":"";f.skip=a-b.pageSize-1,f.skip=f.skip<0?0:f.skip;var h=1!==a?"<a href='?"+d(f)+"'>&larr;Previous </a>":"";return 0==c?"<div class='gammaPager'>No Results</div>":"<div class='gammaPager'>"+h+" Showing "+a+" to "+c+" of "+e+g+"</div>"},j=window.location.search,k=b.dataFormatters||{},l=b.columns,m={};g.load=function(c){c=c||window.location.search,c=c.replace("?","");var j=e(c);j.take=b.pageSize;var n=b.baseUrl.indexOf("?")>-1?b.baseUrl.substring(b.baseUrl.indexOf("?")):"";if(n){var o=e(n);for(var p in o)j[p]||(j[p]=o[p])}c=d(j);var q=a("<div class='loading' />");f.html(""),f.append(q);var r=h+(h.indexOf("?")>-1?"&"+c:"?"+c);a.ajax(r,{method:"GET",dataType:"json",cache:!1,success:function(h){b.onData&&b.onData(h),f.html("");var n=h.results;if(l=l||h.columns,g.count=h.count,g.start=h.start,g.end=h.end,b.search){var o="";j.search&&(o=" value='"+decodeURIComponent(j.search)+"'"),a(document).on("click",".gammaSearch .clearText",function(){a(this).parent().find("input").val(""),delete j.search,c=d(j),window.location.search=c,g.load(c)}),f.html("<form class='gammaSearch'><input type='text' name='search'"+o+" placeholder='Search...' class='gammaSearchField'/><span class='clearText'>x</span></form>")}var p=!0;if(b.tableClasses)var q=b.tableClasses;else var q="";for(var r=a("<table class='gammaGridTable table "+q+"'/>"),s=a("<div class='table-responsive'></div>"),t=0;t<n.length;t++){n[t].id&&(m[n[t].id]=n[t]);var u="odd";t%2==0&&(u="even");var v=a("<tr class='gammaGridRow "+u+"' />"),w=n[t];if(l=l||w,p){var x=a("<thead />");for(var y in l)if("_id"==y||"id"==y){var z=a("<th id='gammaGridHeader_"+y+"' class='gammaGridColumnHeader'></th>"),A=a("<input type='checkbox' class='gammaSelectAll' />"),B=a("<input type='hidden' value='false' id='globalSelectAll'/>"),C=a("<span class='globalText'>All items on this page are selected. </span>"),D=a("<a class='globalTrigger' href='javascript:void(0)'>Select all "+g.count+" items.</a>");D.click(function(b){b.preventDefault(),"true"===B.val()?g.load():(B.val("true"),a(".gammaId").attr("disabled","disabled"),a(".gammaPager a").hide(),C.text("All "+g.count+" items are selected. "),D.text(""))});var E=a("<th class='gammaSelectAll' colspan='"+Object.keys(l).length+"'/>").append(A).append(C).append(D).append(B),F=a("<tr class='gammaSelectAllRow'/>").append(E);F.hide(),x.append(F),A.change(function(){var b=a(this),c=a(".gammaId");c.prop("checked",b.prop("checked")),this.checked?a("tr.gammaGridRow",r).addClass("selected"):a("tr.gammaGridRow",r).removeClass("selected"),this.checked?(C.text(c.length+" items on this page are selected."),F.show()):(F.hide(),B.val("false"),c.removeAttr("disabled"),a(".gammaPager a").show())}),z.append(A),v.append(z)}else{var G=null==l[y]?!1:l[y].sort?l[y].sort:!1;G!==!1&&(G&=h.sort!==y);var H=null===l[y]?y:l[y].title||y;G&&(H=a("<a class='gammaSort' href='?sort="+encodeURIComponent(y)+"'>"+H+"</a>"),H.click(function(){var a=this.href.substring(this.href.lastIndexOf("?")),c=e(a);return j.sort=c.sort,j.skip=0,j.take=b.pageSize,g.load(d(j)),!1}));var I=a("<th id='gammaGridHeader_"+y+"' class='gammaGridColumnHeader' ></th>");y==h.sort&&I.addClass("currentSort"),I.append(H),v.append(I)}x.append(v),r.append(x),p=!1,v=a("<tr class='gammaGridRow' />")}for(var y in l){var J;if("_id"===y||"id"===y){var K=a("<input type='checkbox' class='gammaId' value='"+w[y]+"' />");K.click(function(){var b=a(this);b.attr("checked")?b.parent().parent().addClass("selected"):b.parent().parent().removeClass("selected")}),J=a("<td class='gammaGridColumnData' ></td>"),J.append(K)}else{var L=k[y]?k[y](w[y],w):w[y];if(L||(L=""),l[y].isLink){var M=l[y].href;M.match(/{{\s*[\w\.]+\s*}}/g).map(function(a){var b=a.substring(2,a.length-2),c=w[b];M=M.replace(a,c)}),J=a("<td class='gammaGridColumnData' ><a href='"+M+"'>"+L+"</a></td>")}else l[y].template&&("undefined"==typeof Mustache?console.error("Mustache is required in order to use the template option"):L=Mustache.render(l[y].template,w)),J=a("<td class='gammaGridColumnData' >"+L+"</td>")}y==h.sort&&J.addClass("currentSort"),w.cssClass&&v.addClass(w.cssClass),v.append(J)}r.append(v)}s.append(r),f.append(s),f.append(i(h.start,h.end,h.count,j)),a(".gammaSearch").submit(function(){return window.location.search="search="+encodeURIComponent(a(".gammaSearchField").val()),!1});var N=a("<div class='actionCollection' />"),B=a("#globalSelectAll");b.actions&&a.each(b.actions,function(b,c){var d=a("<input id='gamma_btn_"+b+"' type='button' value='"+b+"' />");N.append(d),d.click(function(){var b=[],d="true"===B.val()?"*":a(".gammaId:checked",f).map(function(){return b.push(m[this.value]),this.value});c.call(g,d,b)})}),f.prepend(N),b.afterLoad&&b.afterLoad.call(g)},error:function(a){console.error("An error occurred during api call",a)}})},g.load(j)}}(jQuery);