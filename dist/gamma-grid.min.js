/*! gamma-grid - v0.1.5 - 2014-11-25
* Copyright (c) 2014 ; Licensed  */
(function(a){a.fn.gammaGrid=function(n,g){if(!Object.keys){Object.keys=function(q){var p=[],o;for(o in q){if(Object.prototype.hasOwnProperty.call(q,o)){p.push(o)}}return p}}function l(q){var p="";for(var o in q){if(o){p+=encodeURIComponent(o)+"="+encodeURIComponent(q[o])+"&"}}if(p.lastIndexOf("&")==p.length-1){p=p.substring(0,p.length-1)}return p}function e(q){if(q.indexOf("?")===0){q=q.substring(1)}var r={};var p=q.split("&");for(var o=0;o<p.length;o++){var s=p[o].split("=");r[decodeURIComponent(s[0])]=decodeURIComponent(s[1]).replace("+"," ")}return r}var b=this;var c={};var i=a("body");b.addClass("gammaGrid");var m=n.baseUrl.indexOf("?")>-1?n.baseUrl.substring(0,n.baseUrl.indexOf("?")):n.baseUrl;var d=n.pager||function(t,o,s,p){p.skip=o;var q=(o<s)?"<a href='?"+l(p)+"'>Next&rarr;</a>":"";p.skip=t-n.pageSize-1;p.skip=p.skip<0?0:p.skip;var r=t!==1?"<a href='?"+l(p)+"'>&larr;Previous </a>":"";if(o==0){return"<div class='gammaPager'>No Results</div>"}else{return"<div class='gammaPager'>"+r+" Showing "+t+" to "+o+" of "+s+q+"</div>"}};var k=window.location.search;var j=n.dataFormatters||{};var f=n.columns;var h={};c.load=function(t){t=t||window.location.search;t=t.replace("?","");var p=e(t);p.take=n.pageSize;var r=n.baseUrl.indexOf("?")>-1?n.baseUrl.substring(n.baseUrl.indexOf("?")):"";if(r){var u=e(r);for(var q in u){if(!p[q]){p[q]=u[q]}}}t=l(p);var s=a("<div class='loading' />");b.html("");b.append(s);var o=m+(m.indexOf("?")>-1?"&"+t:"?"+t);a.ajax(o,{method:"GET",dataType:"json",cache:false,success:function(G){if(n.onData){n.onData(G)}b.html("");var V=G.results;c.count=G.count;c.start=G.start;c.end=G.end;if(n.search){var w="";if(p.search){w=" value='"+decodeURIComponent(p.search)+"'"}a(document).on("click",".gammaSearch .clearText",function(){a(this).parent().find("input").val("");delete p.search;t=l(p);window.location.search=t;c.load(t)});b.html("<form class='gammaSearch'><input type='text' name='search'"+w+" placeholder='Search...' class='gammaSearchField'/><span class='clearText'>x</span></form>")}var z=true;if(n.tableClasses){var U=n.tableClasses}else{var U=""}var y=a("<table class='gammaGridTable table "+U+"'/>");var A=a("<div class='table-responsive'></div>");for(var N=0;N<V.length;N++){if(V[N].id){h[V[N].id]=V[N]}var L="odd";if(N%2==0){L="even"}var v=a("<tr class='gammaGridRow "+L+"' />");var J=V[N];f=f||J;if(z){var O=a("<thead />");for(var W in f){if(W=="_id"||W=="id"){var P=a("<th id='gammaGridHeader_"+W+"' class='gammaGridColumnHeader'></th>");var S=a("<input type='checkbox' class='gammaSelectAll' />");var x=a("<input type='hidden' value='false' id='globalSelectAll'/>");var F=a("<span class='globalText'>All items on this page are selected. </span>");var R=a("<a class='globalTrigger' href='javascript:void(0)'>Select all "+c.count+" items.</a>");R.click(function(X){X.preventDefault();if(x.val()==="true"){c.load()}else{x.val("true");a(".gammaId").attr("disabled","disabled");a(".gammaPager a").hide();F.text("All "+c.count+" items are selected. ");R.text("")}});var E=a("<th class='gammaSelectAll' colspan='"+Object.keys(f).length+"'/>").append(S).append(F).append(R).append(x);var I=a("<tr class='gammaSelectAllRow'/>").append(E);I.hide();O.append(I);S.change(function(){var Y=a(this);var X=a(".gammaId");X.prop("checked",Y.prop("checked"));if(this.checked){a("tr.gammaGridRow",y).addClass("selected")}else{a("tr.gammaGridRow",y).removeClass("selected")}if(this.checked){F.text(X.length+" items on this page are selected.");I.show()}else{I.hide();x.val("false");X.removeAttr("disabled");a(".gammaPager a").show()}});P.append(S);v.append(P)}else{var H=(f[W]==null)?false:f[W].sort?f[W].sort:false;if(H!==false){H&=G.sort!==W}var Q=f[W]===null?W:f[W].title||W;if(H){Q=a("<a class='gammaSort' href='?sort="+encodeURIComponent(W)+"'>"+Q+"</a>");Q.click(function(){var X=this.href.substring(this.href.lastIndexOf("?"));var Y=e(X);p.sort=Y.sort;p.skip=0;p.take=n.pageSize;c.load(l(p));return false})}var B=a("<th id='gammaGridHeader_"+W+"' class='gammaGridColumnHeader' ></th>");if(W==G.sort){B.addClass("currentSort")}B.append(Q);v.append(B)}}O.append(v);y.append(O);z=false;v=a("<tr class='gammaGridRow' />")}for(var W in f){var C;if(W==="_id"||W==="id"){var K=a("<input type='checkbox' class='gammaId' value='"+J[W]+"' />");K.click(function(){var X=a(this);if(X.attr("checked")){X.parent().parent().addClass("selected")}else{X.parent().parent().removeClass("selected")}});C=a("<td class='gammaGridColumnData' ></td>");C.append(K)}else{var T=j[W]?j[W](J[W],J):J[W];if(!T){T=""}if(f[W].isLink){var M=f[W].href;M.match(/{{\s*[\w\.]+\s*}}/g).map(function(Z){var Y=Z.substring(2,Z.length-2);var X=J[Y];M=M.replace(Z,X)});C=a("<td class='gammaGridColumnData' ><a href='"+M+"'>"+T+"</a></td>")}else{if(f[W].template){if(typeof Mustache==="undefined"){console.error("Mustache is required in order to use the template option")}else{T=Mustache.render(f[W].template,J)}}C=a("<td class='gammaGridColumnData' >"+T+"</td>")}}if(W==G.sort){C.addClass("currentSort")}v.append(C)}y.append(v)}A.append(y);b.append(A);b.append(d(G.start,G.end,G.count,p));var D=a("<div class='actionCollection' />");var x=a("#globalSelectAll");if(n.actions){a.each(n.actions,function(X,Z){var Y=a("<input type='button' value='"+X+"' />");D.append(Y);Y.click(function(){var aa=[];var ab=x.val()==="true"?"*":a(".gammaId:checked",b).map(function(){aa.push(h[this.value]);return this.value});Z.call(c,ab,aa)})})}b.prepend(D);if(n.afterLoad){n.afterLoad.call(c)}},error:function(v){console.error("An error occurred during api call",v)}})};c.load(k)}})(jQuery);