/*! gamma-grid - v0.1.5 - 2014-11-25
* Copyright (c) 2014 ; Licensed  */
!function(a){a.fn.gammaGrid=function(b){function c(a){var b="";for(var c in a)c&&(b+=encodeURIComponent(c)+"="+encodeURIComponent(a[c])+"&");return b.lastIndexOf("&")==b.length-1&&(b=b.substring(0,b.length-1)),b}function d(a){0===a.indexOf("?")&&(a=a.substring(1));for(var b={},c=a.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1]).replace("+"," ")}return b}Object.keys||(Object.keys=function(a){var b,c=[];for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&c.push(b);return c});{var e=this,f={};a("body")}e.addClass("gammaGrid");var g=b.baseUrl.indexOf("?")>-1?b.baseUrl.substring(0,b.baseUrl.indexOf("?")):b.baseUrl,h=b.pager||function(a,d,e,f){f.skip=d;var g=e>d?"<a href='?"+c(f)+"'>Next&rarr;</a>":"";f.skip=a-b.pageSize-1,f.skip=f.skip<0?0:f.skip;var h=1!==a?"<a href='?"+c(f)+"'>&larr;Previous </a>":"";return 0==d?"<div class='gammaPager'>No Results</div>":"<div class='gammaPager'>"+h+" Showing "+a+" to "+d+" of "+e+g+"</div>"},i=window.location.search,j=b.dataFormatters||{},k=b.columns,l={};f.load=function(i){i=i||window.location.search,i=i.replace("?","");var m=d(i);m.take=b.pageSize;var n=b.baseUrl.indexOf("?")>-1?b.baseUrl.substring(b.baseUrl.indexOf("?")):"";if(n){var o=d(n);for(var p in o)m[p]||(m[p]=o[p])}i=c(m);var q=a("<div class='loading' />");e.html(""),e.append(q);var r=g+(g.indexOf("?")>-1?"&"+i:"?"+i);a.ajax(r,{method:"GET",dataType:"json",cache:!1,success:function(g){b.onData&&b.onData(g),e.html("");var n=g.results;if(f.count=g.count,f.start=g.start,f.end=g.end,b.search){var o="";m.search&&(o=" value='"+decodeURIComponent(m.search)+"'"),a(document).on("click",".gammaSearch .clearText",function(){a(this).parent().find("input").val(""),delete m.search,i=c(m),window.location.search=i,f.load(i)}),e.html("<form class='gammaSearch'><input type='text' name='search'"+o+" placeholder='Search...' class='gammaSearchField'/><span class='clearText'>x</span></form>")}for(var p=!0,q=a("<table class='gammaGridTable table' />"),r=a("<div class='table-responsive'></div>"),s=0;s<n.length;s++){n[s].id&&(l[n[s].id]=n[s]);var t="odd";s%2==0&&(t="even");var u=a("<tr class='gammaGridRow "+t+"' />"),v=n[s];if(k=k||v,p){var w=a("<thead />");for(var x in k)if("_id"==x||"id"==x){var y=a("<th id='gammaGridHeader_"+x+"' class='gammaGridColumnHeader'></th>"),z=a("<input type='checkbox' class='gammaSelectAll' />"),A=a("<input type='hidden' value='false' id='globalSelectAll'/>"),B=a("<span class='globalText'>All items on this page are selected. </span>"),C=a("<a class='globalTrigger' href='javascript:void(0)'>Select all "+f.count+" items.</a>");C.click(function(b){b.preventDefault(),"true"===A.val()?f.load():(A.val("true"),a(".gammaId").attr("disabled","disabled"),a(".gammaPager a").hide(),B.text("All "+f.count+" items are selected. "),C.text(""))});var D=a("<th class='gammaSelectAll' colspan='"+Object.keys(k).length+"'/>").append(z).append(B).append(C).append(A),E=a("<tr class='gammaSelectAllRow'/>").append(D);E.hide(),w.append(E),z.change(function(){var b=a(this),c=a(".gammaId");c.prop("checked",b.prop("checked")),this.checked?a("tr.gammaGridRow",q).addClass("selected"):a("tr.gammaGridRow",q).removeClass("selected"),this.checked?(B.text(c.length+" items on this page are selected."),E.show()):(E.hide(),A.val("false"),c.removeAttr("disabled"),a(".gammaPager a").show())}),y.append(z),u.append(y)}else{var F=null==k[x]?!1:k[x].sort?k[x].sort:!1;F!==!1&&(F&=g.sort!==x);var G=null===k[x]?x:k[x].title||x;F&&(G=a("<a class='gammaSort' href='?sort="+encodeURIComponent(x)+"'>"+G+"</a>"),G.click(function(){var a=this.href.substring(this.href.lastIndexOf("?")),e=d(a);return m.sort=e.sort,m.skip=0,m.take=b.pageSize,f.load(c(m)),!1}));var H=a("<th id='gammaGridHeader_"+x+"' class='gammaGridColumnHeader' ></th>");x==g.sort&&H.addClass("currentSort"),H.append(G),u.append(H)}w.append(u),q.append(w),p=!1,u=a("<tr class='gammaGridRow' />")}for(var x in k){var I;if("_id"===x||"id"===x){var J=a("<input type='checkbox' class='gammaId' value='"+v[x]+"' />");J.click(function(){var b=a(this);b.attr("checked")?b.parent().parent().addClass("selected"):b.parent().parent().removeClass("selected")}),I=a("<td class='gammaGridColumnData' ></td>"),I.append(J)}else{var K=j[x]?j[x](v[x],v):v[x];if(K||(K=""),k[x].isLink){var L=k[x].href;L.match(/{{\s*[\w\.]+\s*}}/g).map(function(a){var b=a.substring(2,a.length-2),c=v[b];L=L.replace(a,c)}),I=a("<td class='gammaGridColumnData' ><a href='"+L+"'>"+K+"</a></td>")}else k[x].template&&("undefined"==typeof Mustache?console.error("Mustache is required in order to use the template option"):K=Mustache.render(k[x].template,v)),I=a("<td class='gammaGridColumnData' >"+K+"</td>")}x==g.sort&&I.addClass("currentSort"),u.append(I)}q.append(u)}r.append(q),e.append(r),e.append(h(g.start,g.end,g.count,m));var M=a("<div class='actionCollection' />"),A=a("#globalSelectAll");b.actions&&a.each(b.actions,function(b,c){var d=a("<input type='button' value='"+b+"' />");M.append(d),d.click(function(){var b=[],d="true"===A.val()?"*":a(".gammaId:checked",e).map(function(){return b.push(l[this.value]),this.value});c.call(f,d,b)})}),e.prepend(M),b.afterLoad&&b.afterLoad.call(f)},error:function(a){console.error("An error occurred during api call",a)}})},f.load(i)}}(jQuery);