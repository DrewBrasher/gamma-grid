/*! gamma-grid - v0.1.1 - 2014-04-01
* Copyright (c) 2014 ; Licensed  */
!function(a){a.fn.gammaGrid=function(b){function c(a){var b="";for(var c in a)c&&(b+=encodeURIComponent(c)+"="+encodeURIComponent(a[c])+"&");return b.lastIndexOf("&")==b.length-1&&(b=b.substring(0,b.length-1)),b}function d(a){0===a.indexOf("?")&&(a=a.substring(1));for(var b={},c=a.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");b[decodeURIComponent(e[0])]=decodeURIComponent(e[1]).replace("+"," ")}return b}Object.keys||(Object.keys=function(a){var b,c=[];for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&c.push(b);return c});{var e=this,f={};a("body")}e.addClass("gammaGrid");var g=b.baseUrl.indexOf("?")>-1?b.baseUrl.substring(0,b.baseUrl.indexOf("?")):b.baseUrl,h=b.pager||function(a,d,e,f){f.skip=d;var g=e>d?"<a href='?"+c(f)+"'>Next&nbsp;&mdash;&gt;</a>":"";f.skip=a-b.pageSize-1,f.skip=f.skip<0?0:f.skip;var h=1!==a?"<a href='?"+c(f)+"'>&lt;&mdash;&nbsp;Previous </a>":"";return 0==d?"<div class='gammaPager'>No Results</div>":"<div class='gammaPager'>"+h+" Showing "+a+" to "+d+" of "+e+g+"</div>"},i=window.location.search,j=b.dataFormatters||{},k=b.columns,l={};f.load=function(i){i=i||window.location.search,i=i.replace("?","");var m=d(i);m.take=b.pageSize;var n=b.baseUrl.indexOf("?")>-1?b.baseUrl.substring(b.baseUrl.indexOf("?")):"";if(n){var o=d(n);for(var p in o)m[p]||(m[p]=o[p])}i=c(m);var q=a("<div class='loading' />");e.html(""),e.append(q);var r=g+(g.indexOf("?")>-1?"&"+i:"?"+i);a.ajax(r,{method:"GET",dataType:"json",cache:!1,success:function(g){e.html("");var n=g.results;if(f.count=g.count,f.start=g.start,f.end=g.end,b.search){var o="";m.search&&(o=" value='"+decodeURIComponent(m.search)+"'"),a(document).on("click",".gammaSearch .clearText",function(){a(this).parent().find("input").val(""),delete m.search,i=c(m),window.location.search=i,f.load(i)}),e.html("<form class='gammaSearch'><input type='text' name='search'"+o+" placeholder='Search...' class='gammaSearchField'/><span class='clearText'>x</span></form>")}for(var p=!0,q=a("<table class='gammaGridTable' />"),r=0;r<n.length;r++){n[r].id&&(l[n[r].id]=n[r]);var s="odd";r%2==0&&(s="even");var t=a("<tr class='gammaGridRow "+s+"' />"),u=n[r];if(k=k||u,p){var v=a("<thead />");for(var w in k)if("id"==w){var x=a("<th id='gammaGridHeader_"+w+"' class='gammaGridColumnHeader'></th>"),y=a("<input type='checkbox' class='gammaSelectAll' />"),z=a("<input type='hidden' value='false' id='globalSelectAll'/>"),A=a("<span class='globalText'>All items on this page are selected. </span>"),B=a("<a class='globalTrigger' href='javascript:void(0)'>Select all "+f.count+" items.</a>");B.click(function(b){b.preventDefault(),"true"===z.val()?f.load():(z.val("true"),a(".gammaId").attr("disabled","disabled"),a(".gammaPager a").hide(),A.text("All "+f.count+" items are selected. "),B.text(""))});var C=a("<th class='gammaSelectAll' colspan='"+Object.keys(k).length+"'/>").append(y).append(A).append(B).append(z),D=a("<tr class='gammaSelectAllRow'/>").append(C);D.hide(),v.append(D),y.change(function(){var b=a(this),c=a(".gammaId");c.prop("checked",b.prop("checked")),this.checked?a("tr.gammaGridRow",q).addClass("selected"):a("tr.gammaGridRow",q).removeClass("selected"),this.checked?(A.text(c.length+" items on this page are selected."),D.show()):(D.hide(),z.val("false"),c.removeAttr("disabled"),a(".gammaPager a").show())}),x.append(y),t.append(x)}else{var E=null==k[w]?!1:k[w].sort?k[w].sort:!1;E!==!1&&(E&=g.sort!==w);var F=null===k[w]?w:k[w].title||w;E&&(F=a("<a class='gammaSort' href='?sort="+encodeURIComponent(w)+"'>"+F+"</a>"),F.click(function(){var a=this.href.substring(this.href.lastIndexOf("?"));return m=d(a),m.skip=0,m.take=b.pageSize,f.load(a),!1}));var G=a("<th id='gammaGridHeader_"+w+"' class='gammaGridColumnHeader' ></th>");w==g.sort&&G.addClass("currentSort"),G.append(F),t.append(G)}v.append(t),q.append(v),p=!1,t=a("<tr class='gammaGridRow' />")}for(var w in k){var H;if("id"==w){var I=a("<input type='checkbox' class='gammaId' value='"+u[w]+"' />");I.click(function(){var b=a(this);b.attr("checked")?b.parent().parent().addClass("selected"):b.parent().parent().removeClass("selected")}),H=a("<td class='gammaGridColumnData' ></td>"),H.append(I)}else{var J=j[w]?j[w](u[w],u):u[w];if(J||(J=""),k[w].isLink){var K=k[w].href;K.match(/{{\s*[\w\.]+\s*}}/g).map(function(a){var b=a.substring(2,a.length-2),c=u[b];K=K.replace(a,c)}),H=a("<td class='gammaGridColumnData' ><a href='"+K+"'>"+J+"</a></td>")}else k[w].template&&("undefined"==typeof Mustache?console.error("Mustache is required in order to use the template option"):J=Mustache.render(k[w].template,u)),H=a("<td class='gammaGridColumnData' >"+J+"</td>")}w==g.sort&&H.addClass("currentSort"),t.append(H)}q.append(t)}e.append(q),e.append(h(g.start,g.end,g.count,m));var L=a("<div class='actionCollection' />"),z=a("#globalSelectAll");b.actions&&a.each(b.actions,function(b,c){var d=a("<input type='button' value='"+b+"' />");L.append(d),d.click(function(){var b=[],d="true"===z.val()?"*":a(".gammaId:checked",e).map(function(){return b.push(l[this.value]),this.value});c.call(f,d,b)})}),e.prepend(L),b.afterLoad&&b.afterLoad.call(f)},error:function(a){console.error("An error occurred during api call",a)}})},f.load(i)}}(jQuery);